{% extends "network/layout.html" %}

{% block body %}

<style>
/* ===============================
   Messages Inbox (Scoped & Safe)
   =============================== */
.messages-inbox .conversation-item{
  border:1px solid #e5e7eb;
  border-radius:14px;
  padding:14px 16px;
  background:#fff;
  transition:0.2s ease;
}
.messages-inbox .conversation-item:hover{
  background:#f8fafc;
  transform:translateY(-1px);
  box-shadow:0 4px 14px rgba(0,0,0,0.04);
}
.messages-inbox .username{
  font-weight:700;
  color:#0d6efd;
  cursor:pointer;
}
.messages-inbox .username:hover{
  text-decoration:underline;
}
.messages-inbox .preview-text{
  color:#6b7280;
  font-size:14px;
  line-height:1.4;
}
.messages-inbox .time-text{
  font-size:12px;
  color:#9ca3af;
  white-space:nowrap;
}
.messages-inbox .badge{
  font-size:12px;
}
@media (max-width:576px){
  .messages-inbox .conversation-item{ padding:12px; }
}
</style>

<div class="container my-4 messages-inbox">
  <h4 class="mb-3">Messages</h4>

  {% if conversations %}
    <div class="list-group gap-2 d-flex flex-column">
      {% for conv in conversations %}
        <a href="{% url 'conversation' conv.user.username %}"
           class="conversation-item text-decoration-none d-flex justify-content-between align-items-start">

          <div class="flex-grow-1 pe-2">
            <div class="d-flex align-items-center gap-2 mb-1">
              <strong class="username clickable-username"
                      data-username="{{ conv.user.username }}">
                {{ conv.user.username }}
              </strong>

              {% if conv.unread_count > 0 %}
                <span class="badge bg-primary rounded-pill">
                  {{ conv.unread_count }}
                </span>
              {% endif %}
            </div>

            <!-- Media-aware preview -->
            <div class="preview-text"
                 data-message="{{ conv.latest_message.content|default:''|escape }}">
              Loadingâ€¦
            </div>
          </div>

          <div class="time-text">
            {{ conv.latest_message.timestamp|timesince }} ago
          </div>

        </a>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info text-center py-5 rounded-4 shadow-sm">
      <h5>No messages yet</h5>
      <p class="mb-0">Send a message from a profile to start a conversation.</p>
    </div>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

  /* Username â†’ profile */
  document.querySelectorAll('.clickable-username').forEach(el => {
    el.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = `/profile/${this.dataset.username}`;
    });
  });

  /* ---------------------------------------
     Media detection (FIXED & EXCLUSIVE)
     --------------------------------------- */
  document.querySelectorAll('.preview-text[data-message]').forEach(el => {
    const msg = el.dataset.message;

    if (!msg) {
      el.textContent = 'No messages yet';
      return;
    }

    const output = [];
    const tokens = msg.split(/\s+/);

    tokens.forEach(token => {
      const t = token.toLowerCase();

      // âœ… STICKER â€” exclusive match
      if (t.includes('sticker')) {
        output.push('ðŸ·ï¸ Sticker');
        return; // â›” stop further checks for this token
      }

      // âœ… GIF â€” only if NOT sticker
      if (t.includes('.gif') || t.includes('giphy.com')) {
        output.push('ðŸŽžï¸ GIF');
      }
    });

    if (output.length > 0) {
      el.textContent = output.join(' ');
    } else {
      el.textContent = msg.split(/\s+/).slice(0, 10).join(' ');
    }
  });

});
</script>

{% endblock %}
