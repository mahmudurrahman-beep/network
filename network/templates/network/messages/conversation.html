{% extends "network/layout.html" %}
{% load static %}
{% load parse_media %}

{% block body %}
<style>
/* All your existing CSS remains the same */
/* Add this new style for preview */
.live-preview-box {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 12px;
    margin-top: 10px;
    min-height: 80px;
    display: none;
}

.live-preview-box.active {
    display: block;
    animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

.preview-placeholder {
    color: #adb5bd;
    font-style: italic;
}

.preview-content img {
    max-width: 100% !important;
    height: auto !important;
    border-radius: 8px;
    margin: 4px 0;
}

.preview-gif {
    max-width: 200px !important;
}

.preview-sticker {
    max-width: 100px !important;
    background: transparent !important;
}
</style>

<div class="chat-container">
    <!-- Chat Header (unchanged) -->
    <div class="chat-header">
        <!-- ... your existing header code ... -->
    </div>

    <!-- Chat Messages -->
    <div class="chat-box">
        <!-- ... your existing messages loop ... -->
    </div>

    <!-- Chat Input Area -->
    <div class="chat-input-area">
        <form method="post" enctype="multipart/form-data" id="message-form">
            {% csrf_token %}
            
            <!-- Quick Emoji Bar -->
            <div class="quick-emoji-bar">
                <!-- ... your existing emoji buttons ... -->
            </div>
            
            <!-- Media Picker -->
            <div class="media-picker-section">
                <!-- ... your existing media picker code ... -->
            </div>

            <!-- Message Input with Live Preview -->
            <div class="d-flex gap-2 align-items-start">
                <div style="flex: 1;">
                    <textarea name="content" class="message-textarea" rows="2" 
                              placeholder="Type your message..." id="message-content" 
                              required data-preview-target="chatPreview"></textarea>
                    
                    <!-- LIVE PREVIEW BOX -->
                    <div id="chatPreview" class="live-preview-box">
                        <small class="text-muted d-block mb-2">Preview:</small>
                        <div class="preview-content">
                            <div class="preview-placeholder">Type to see preview...</div>
                        </div>
                    </div>
                </div>
                
                <label class="attach-btn mb-0" for="message-media-input">
                    ðŸ“Ž Attach
                </label>
                <input type="file" name="media" class="d-none" accept="image/*,video/*,.gif" id="message-media-input">
                
                <button type="submit" class="send-btn">
                    Send âž¤
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Add emoji to textarea and trigger preview
function addEmoji(emoji) {
    const textarea = document.getElementById('message-content');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    
    textarea.value = text.substring(0, start) + emoji + text.substring(end);
    textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
    textarea.focus();
    
    // Trigger preview update
    updateLivePreview(textarea);
}

// Toggle media panel
function toggleMediaPanel() {
    const mediaResults = document.getElementById('media-results');
    if (mediaResults.style.display === 'none' || mediaResults.style.display === '') {
        document.getElementById('media-search').value = 'trending';
        handleMediaSearch();
    } else {
        mediaResults.style.display = 'none';
    }
}

// Media type toggle
let currentMediaType = 'gifs';

document.querySelectorAll('.media-type-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        currentMediaType = this.dataset.mediaType;
        document.querySelectorAll('.media-type-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        document.getElementById('media-search').placeholder = currentMediaType === 'gifs' ? 'Search GIFs...' : 'Search Stickers...';
    });
});

// Media search
document.getElementById('media-search-btn').addEventListener('click', handleMediaSearch);
document.getElementById('media-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        handleMediaSearch();
    }
});

function handleMediaSearch() {
    const query = document.getElementById('media-search').value.trim() || 'trending';
    const results = document.getElementById('media-results');
    const textarea = document.getElementById('message-content');
    
    results.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm"></div></div>';
    results.style.display = 'block';
    
    fetch(`/search-gifs/?q=${encodeURIComponent(query)}&type=${currentMediaType}`)
        .then(r => r.json())
        .then(data => {
            results.innerHTML = '';
            if (data.gifs && data.gifs.length > 0) {
                const close = document.createElement('button');
                close.className = 'btn btn-sm btn-outline-secondary mb-2';
                close.textContent = 'âœ• Close';
                close.onclick = () => results.style.display = 'none';
                results.appendChild(close);
                
                const grid = document.createElement('div');
                grid.className = 'd-flex flex-wrap gap-2';
                grid.style.maxHeight = '200px';
                grid.style.overflowY = 'auto';
                
                data.gifs.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.style.width = '80px';
                    img.style.height = '80px';
                    img.style.objectFit = 'cover';
                    img.style.cursor = 'pointer';
                    img.style.borderRadius = '8px';
                    img.className = 'border';
                    img.alt = 'Media result';
                    img.onclick = () => {
                        const tag = currentMediaType === 'gifs' ? 'GIF' : 'STICKER';
                        const cursorPos = textarea.selectionStart;
                        const textBefore = textarea.value.substring(0, cursorPos);
                        const textAfter = textarea.value.substring(cursorPos);
                        
                        textarea.value = textBefore + `[${tag}:${url}]` + textAfter;
                        textarea.focus();
                        results.style.display = 'none';
                        
                        // Update preview
                        updateLivePreview(textarea);
                    };
                    grid.appendChild(img);
                });
                results.appendChild(grid);
            } else {
                results.innerHTML = '<p class="text-muted text-center">No results found.</p>';
            }
        })
        .catch(error => {
            console.error('Media search error:', error);
            results.innerHTML = '<p class="text-danger text-center">Failed to load media.</p>';
        });
}

// LIVE PREVIEW FUNCTION
function updateLivePreview(textarea) {
    const previewId = textarea.dataset.previewTarget;
    const previewBox = document.getElementById(previewId);
    const previewContent = previewBox.querySelector('.preview-content');
    const text = textarea.value.trim();
    
    if (!text) {
        previewBox.classList.remove('active');
        previewBox.style.display = 'none';
        previewContent.innerHTML = '<div class="preview-placeholder">Type to see preview...</div>';
        return;
    }
    
    // Show preview
    previewBox.style.display = 'block';
    previewBox.classList.add('active');
    
    // Parse and format content for preview
    let html = text
        .replace(/\[GIF:(https?:\/\/[^\]]+)\]/gi, 
            '<img src="$1" class="preview-gif" alt="GIF preview" loading="lazy" onerror="this.style.opacity=0.5;">')
        .replace(/\[STICKER:(https?:\/\/[^\]]+)\]/gi, 
            '<img src="$1" class="preview-sticker" alt="Sticker preview" loading="lazy" onerror="this.style.opacity=0.5;">')
        .replace(/\n/g, '<br>');
    
    // Show text only if no media tags
    if (html === text) {
        html = text.replace(/\n/g, '<br>');
    }
    
    previewContent.innerHTML = html || '<div class="preview-placeholder">Type to see preview...</div>';
}

// Initialize live preview
document.addEventListener('DOMContentLoaded', function() {
    const messageTextarea = document.getElementById('message-content');
    
    // Set up input listener
    if (messageTextarea) {
        messageTextarea.addEventListener('input', function() {
            updateLivePreview(this);
        });
        
        // Also trigger on paste
        messageTextarea.addEventListener('paste', function(e) {
            setTimeout(() => updateLivePreview(this), 10);
        });
        
        // Initial check
        setTimeout(() => updateLivePreview(messageTextarea), 100);
    }
    
    // Auto-scroll to bottom
    setTimeout(() => {
        const chatBox = document.querySelector('.chat-box');
        if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
    }, 100);
});
</script>
{% endblock %}
