<!--
================================================================================
ARGON SOCIAL NETWORK - PRIVACY & SAFETY SETTINGS
================================================================================

@file        privacy_settings.html
@purpose     User privacy and safety configuration page
@author      Argon Admin
@date        February 2026
@extends     network/layout.html
@requires    Bootstrap 4, Font Awesome
@context     request.user, privacy_form

FEATURES:
â€¢ Account privacy toggle (public/private)
â€¢ Default post visibility settings
â€¢ Tagging permissions control
â€¢ Online status visibility toggle
â€¢ Message notification preferences
â€¢ Comment notification preferences

SECURITY:
â€¢ CSRF protection on forms
â€¢ Authentication required
â€¢ User-specific settings

FILE LOCATION: templates/network/privacy_settings.html

================================================================================
-->

{% extends "network/layout.html" %}
{% load static %}

{% block body %}
<div class="container mt-4 mb-4">
  <div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">

      <!-- Page title -->
      <div class="mb-3">
        <h2 class="h4 mb-1">Privacy &amp; Safety</h2>
        <p class="text-muted mb-0">
          Control who sees your posts, who can interact with you, and how Argon alerts you about new messages.
        </p>
      </div>

      <!-- Message alert settings -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><strong>Message alerts</strong></span>
          <small class="text-muted d-none d-md-inline">
            Only affects your account
          </small>
        </div>
        <div class="card-body">

          <!-- Badge toggle -->
          <div class="form-group mb-3">
            <div class="custom-control custom-switch">
              <input
                type="checkbox"
                class="custom-control-input"
                id="msgBadgeToggle"
                {% if user.message_badge_enabled %}checked{% endif %}
              >
              <label class="custom-control-label" for="msgBadgeToggle">
                <span class="font-weight-semibold">Show badge on app icon</span>
                <small class="d-block text-muted">
                  Shows unread <strong>message</strong> count on the Argon app icon or browser tab when supported.
                </small>
              </label>
            </div>
          </div>

          <!-- Sound toggle -->
          <div class="form-group mb-3">
            <div class="custom-control custom-switch">
              <input
                type="checkbox"
                class="custom-control-input"
                id="msgSoundToggle"
                {% if user.message_sound_enabled %}checked{% endif %}
              >
              <label class="custom-control-label" for="msgSoundToggle">
                <span class="font-weight-semibold">Play sound for new messages</span>
              </label>
            </div>
          </div>

          <!-- Sound choice -->
          <div class="form-group mb-3" id="msgSoundChoiceGroup">
            <label class="mb-1 font-weight-semibold">Sound type</label>
            <select class="custom-select" id="msgSoundChoice">
              <option value="ding"
                {% if user.message_sound_choice == "ding" %}selected{% endif %}
              >
                Ding
              </option>
              <option value="pop"
                {% if user.message_sound_choice == "pop" %}selected{% endif %}
              >
                Pop
              </option>
              <option value="chime"
                {% if user.message_sound_choice == "chime" %}selected{% endif %}
              >
                Chime
              </option>
            </select>
            <small class="form-text text-muted">
              Plays when a new message arrives and youâ€™re not viewing the messages page.
            </small>
          </div>

          <div class="d-flex justify-content-between">
            <button class="btn btn-outline-secondary btn-sm" id="msgTestSoundBtn">
              ðŸ”” Test sound
            </button>
            <button class="btn btn-primary btn-sm" id="msgSaveSettingsBtn">
              ðŸ’¾ Save message alert settings
            </button>
          </div>

        </div>
      </div>

      <!-- Post visibility settings -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header">
          <strong>Post visibility</strong>
        </div>
        <div class="card-body">
          <p class="text-muted">
            Choose who can see your posts on Argon.
          </p>
          <form method="post" action="{% url 'privacy_settings' %}">
            {% csrf_token %}
            <div class="form-group">
              <label for="post_visibility" class="font-weight-semibold mb-1">
                Who can see your posts?
              </label>
              <select
                id="post_visibility"
                name="post_visibility"
                class="form-control"
              >
                <option value="universal"
                  {% if privacy_settings.post_visibility == "universal" %}selected{% endif %}
                >
                  Everyone
                </option>
                <option value="followers"
                  {% if privacy_settings.post_visibility == "followers" %}selected{% endif %}
                >
                  Only your followers
                </option>
                <option value="following"
                  {% if privacy_settings.post_visibility == "following" %}selected{% endif %}
                >
                  Only people you follow
                </option>
                <option value="both"
                  {% if privacy_settings.post_visibility == "both" %}selected{% endif %}
                >
                  Mutual followers only 
                </option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary btn-sm">
              ðŸ’¾ Save privacy settings
            </button>
          </form>
        </div>
      </div>

      <!-- Blocked users -->
      <div class="card shadow-sm border-0">
        <div class="card-header">
          <strong>Blocked users</strong>
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">
            Users youâ€™ve blocked wonâ€™t see your posts or be able to interact with you.
          </p>

          {% if blocked_users %}
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th scope="col">Username</th>
                    <th scope="col" class="d-none d-sm-table-cell">Blocked since</th>
                    <th scope="col" class="text-right">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for block in blocked_users %}
                    <tr>
                      <td class="align-middle">
                        <a href="{% url 'profile' block.blocked.username %}">
                          @{{ block.blocked.username }}
                        </a>
                      </td>
                      <td class="d-none d-sm-table-cell align-middle">
                        {{ block.timestamp|date:"M d, Y" }}
                      </td>
                      <td class="text-right align-middle">
                        <a
                          href="{% url 'unblock_user' block.blocked.username %}"
                          class="btn btn-outline-danger btn-sm"
                        >
                          Unblock
                        </a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="mb-0 text-muted">
              You havenâ€™t blocked any users.
            </p>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Inline JS for message alert settings -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const badgeToggle = document.getElementById("msgBadgeToggle");
  const soundToggle = document.getElementById("msgSoundToggle");
  const soundChoice = document.getElementById("msgSoundChoice");
  const soundChoiceGroup = document.getElementById("msgSoundChoiceGroup");
  const testSoundBtn = document.getElementById("msgTestSoundBtn");
  const saveSettingsBtn = document.getElementById("msgSaveSettingsBtn");

  if (!badgeToggle || !soundToggle) {
    return;
  }

  function refreshSoundChoiceVisibility() {
    soundChoiceGroup.style.display = soundToggle.checked ? "block" : "none";
  }
  refreshSoundChoiceVisibility();
  soundToggle.addEventListener("change", refreshSoundChoiceVisibility);

  function getCSRFToken() {
    const name = "csrftoken=";
    const parts = document.cookie.split(";");
    for (let c of parts) {
      c = c.trim();
      if (c.startsWith(name)) {
        return c.substring(name.length);
      }
    }
    return "";
  }

  // Test sound
  testSoundBtn.addEventListener("click", function () {
    const soundFile = soundChoice.value || "ding";
    const audio = new Audio(`/static/network/sounds/${soundFile}.mp3`);
    audio.volume = 0.3;
    audio.play().catch(function () {});
  });

  // Save settings
  saveSettingsBtn.addEventListener("click", function () {
    const payload = {
      message_badge_enabled: badgeToggle.checked,
      message_sound_enabled: soundToggle.checked,
      message_sound_choice: soundChoice.value
    };

    fetch("/api/update-message-settings/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken()
      },
      body: JSON.stringify(payload)
    })
      .then(function (r) { return r.json(); })
      .then(function (data) {
        if (data.status === "success") {
          alert("Message alert settings saved");
        } else {
          alert("Error saving settings");
        }
      })
      .catch(function () {
        alert("Network error saving settings");
      });
  });
});
</script>
{% endblock %} 

<!--
================================================================================
END OF privacy_settings.html - Author: Argon Admin
================================================================================

MAINTAINER: Argon Admin
LAST UPDATED: February 2026

RELATED TEMPLATES:
â€¢ profile.html - User profile
â€¢ layout.html - Base template

================================================================================
-->
