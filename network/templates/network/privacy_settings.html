<!--
================================================================================
ARGON NETWORK - PRIVACY & SAFETY SETTINGS 
================================================================================

@file        privacy_settings.html
@purpose     User privacy and safety configuration page
@author      Argon Admin
@date        February 2026
@version     Badge toggle removed
================================================================================
-->

{% extends "network/layout.html" %}
{% load static %}

{% block body %}
<div class="container mt-4 mb-4">
  <div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">

      <!-- Page title -->
      <div class="mb-3">
        <h2 class="h4 mb-1">Privacy &amp; Safety</h2>
        <p class="text-muted mb-0">
          Control who sees your posts and customize your message notifications.
        </p>
      </div>

      <!-- Message notification settings -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><strong>Message notifications</strong></span>
          <small class="text-muted d-none d-md-inline">
            Sound alerts
          </small>
        </div>
        <div class="card-body">

          <!-- Sound toggle -->
          <div class="form-group mb-3">
            <div class="custom-control custom-switch">
              <input
                type="checkbox"
                class="custom-control-input"
                id="msgSoundToggle"
                {% if user.message_sound_enabled %}checked{% endif %}
              >
              <label class="custom-control-label" for="msgSoundToggle">
                <span class="font-weight-semibold">Play sound for new messages</span>
                <small class="d-block text-muted mt-1">
                  Hear a notification sound when new messages arrive while using Argon.
                </small>
              </label>
            </div>
          </div>

          <!-- Sound choice -->
          <div class="form-group mb-3" id="msgSoundChoiceGroup">
            <label class="mb-1 font-weight-semibold">Notification sound</label>
            <select class="custom-select" id="msgSoundChoice">
              <option value="ding"
                {% if user.message_sound_choice == "ding" %}selected{% endif %}
              >
                üîî Ding
              </option>
              <option value="pop"
                {% if user.message_sound_choice == "pop" %}selected{% endif %}
              >
                üí¨ Pop
              </option>
              <option value="chime"
                {% if user.message_sound_choice == "chime" %}selected{% endif %}
              >
                üéµ Chime
              </option>
            </select>
            <small class="form-text text-muted">
              Sound plays when a new message arrives and you're not viewing the messages page.
            </small>
          </div>

          <!-- Info box about how message notifications work -->
          <div class="alert alert-info mb-3" style="font-size: 0.9rem;">
            <strong>üí° How message alerts work:</strong>
            <ul class="mb-0 mt-2 pl-3">
              <li><strong>Sound alerts:</strong> Play when app is open and active</li>
              <li><strong>Unread count:</strong> Always visible in navigation bar (top right)</li>
              <li><strong>Updates:</strong> Real-time when using Argon, or when you open the app</li>
            </ul>
          </div>

          <div class="d-flex flex-column flex-sm-row justify-content-between">
            <button class="btn btn-outline-secondary btn-sm mb-2 mb-sm-0" id="msgTestSoundBtn">
              üîä Test sound
            </button>
            <button class="btn btn-primary btn-sm" id="msgSaveSettingsBtn">
              üíæ Save notification settings
            </button>
          </div>

        </div>
      </div>

      <!-- Post visibility settings -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header">
          <strong>Post visibility</strong>
        </div>
        <div class="card-body">
          <p class="text-muted">
            Choose who can see your posts on Argon.
          </p>
          <form method="post" action="{% url 'privacy_settings' %}">
            {% csrf_token %}
            <div class="form-group">
              <label for="post_visibility" class="font-weight-semibold mb-1">
                Who can see your posts?
              </label>
              <select
                id="post_visibility"
                name="post_visibility"
                class="form-control"
              >
                <option value="universal"
                  {% if privacy_settings.post_visibility == "universal" %}selected{% endif %}
                >
                  Everyone
                </option>
                <option value="followers"
                  {% if privacy_settings.post_visibility == "followers" %}selected{% endif %}
                >
                  Only your followers
                </option>
                <option value="following"
                  {% if privacy_settings.post_visibility == "following" %}selected{% endif %}
                >
                  Only people you follow
                </option>
                <option value="both"
                  {% if privacy_settings.post_visibility == "both" %}selected{% endif %}
                >
                  Mutual followers only
                </option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary btn-sm">
              üíæ Save privacy settings
            </button>
          </form>
        </div>
      </div>

      <!-- Blocked users -->
      <div class="card shadow-sm border-0">
        <div class="card-header">
          <strong>Blocked users</strong>
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">
            Users you've blocked won't see your posts or be able to interact with you.
          </p>

          {% if blocked_users %}
            <div class="table-responsive">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th scope="col">Username</th>
                    <th scope="col" class="d-none d-sm-table-cell">Blocked since</th>
                    <th scope="col" class="text-right">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for block in blocked_users %}
                    <tr>
                      <td class="align-middle">
                        <a href="{% url 'profile' block.blocked.username %}">
                          @{{ block.blocked.username }}
                        </a>
                      </td>
                      <td class="d-none d-sm-table-cell align-middle">
                        {{ block.timestamp|date:"M d, Y" }}
                      </td>
                      <td class="text-right align-middle">
                        <a
                          href="{% url 'unblock_user' block.blocked.username %}"
                          class="btn btn-outline-danger btn-sm"
                        >
                          Unblock
                        </a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="mb-0 text-muted">
              You haven't blocked any users.
            </p>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Inline JS for message sound settings -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const soundToggle = document.getElementById("msgSoundToggle");
  const soundChoice = document.getElementById("msgSoundChoice");
  const soundChoiceGroup = document.getElementById("msgSoundChoiceGroup");
  const testSoundBtn = document.getElementById("msgTestSoundBtn");
  const saveSettingsBtn = document.getElementById("msgSaveSettingsBtn");

  if (!soundToggle) {
    return;
  }

  function refreshSoundChoiceVisibility() {
    soundChoiceGroup.style.display = soundToggle.checked ? "block" : "none";
  }
  refreshSoundChoiceVisibility();
  soundToggle.addEventListener("change", refreshSoundChoiceVisibility);

  function getCSRFToken() {
    const name = "csrftoken=";
    const parts = document.cookie.split(";");
    for (let c of parts) {
      c = c.trim();
      if (c.startsWith(name)) {
        return c.substring(name.length);
      }
    }
    return "";
  }

  // Test sound
  testSoundBtn.addEventListener("click", function () {
    const soundFile = soundChoice.value || "ding";
    const audio = new Audio(`/static/network/sounds/${soundFile}.mp3`);
    audio.volume = 0.3;
    audio.play().catch(function (err) {
      console.log('Sound play blocked:', err);
      alert('üîä Tap anywhere on the page first to enable sound, then try again.');
    });
  });

  // Save settings (removed message_badge_enabled)
  saveSettingsBtn.addEventListener("click", function () {
    const payload = {
      message_sound_enabled: soundToggle.checked,
      message_sound_choice: soundChoice.value
    };

    // Disable button during save
    saveSettingsBtn.disabled = true;
    const originalText = saveSettingsBtn.textContent;
    saveSettingsBtn.textContent = "Saving...";

    fetch("/api/update-message-settings/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken()
      },
      body: JSON.stringify(payload)
    })
      .then(function (r) { return r.json(); })
      .then(function (data) {
        if (data.status === "success") {
          alert("‚úÖ Notification settings saved!");
        } else {
          alert("‚ùå Error saving settings. Please try again.");
        }
      })
      .catch(function () {
        alert("‚ùå Network error. Please check your connection.");
      })
      .finally(function () {
        // Re-enable button
        saveSettingsBtn.disabled = false;
        saveSettingsBtn.textContent = originalText;
      });
  });
});
</script>
{% endblock %}

<!--
================================================================================
END OF privacy_settings.html 
================================================================================

RELATED FILES:
‚Ä¢ main.js 
‚Ä¢ layout.html 
‚Ä¢ views.py 

================================================================================
-->
