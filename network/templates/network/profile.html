{% extends "network/layout.html" %}
{% load static %}

{% block body %}
<style>
    /* Profile page specific styles */
    .profile-avatar {
        width: 140px;
        height: 140px;
        object-fit: cover;
        border: 5px solid #fff;
        box-shadow: 0 12px 32px rgba(8, 48, 71, 0.12);
        transition: transform 0.3s ease;
    }
    
    .profile-avatar:hover {
        transform: scale(1.03);
    }
    
    .profile-upload-label {
        bottom: -10px;
        right: -10px;
        width: 50px;
        height: 50px;
        cursor: pointer;
        z-index: 10;
    }
    
    .profile-upload-icon {
        width: 100%;
        height: 100%;
        border: 4px solid white;
        font-size: 24px;
        background: linear-gradient(90deg, var(--brand-blue), var(--brand-teal));
        color: white;
        transition: all 0.2s ease;
    }
    
    .profile-upload-icon:hover {
        transform: scale(1.1);
        box-shadow: 0 8px 24px rgba(6, 98, 150, 0.2);
    }
    
    .profile-actions {
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .profile-action-btn {
        min-width: 120px;
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: 700;
        transition: all 0.2s ease;
        border: 2px solid transparent;
    }
    
    .profile-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(2, 6, 23, 0.12);
    }
</style>

<div class="container my-4">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-4" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    {% endfor %}
  {% endif %}

<div class="text-center mb-5">

    <!-- Avatar -->
    <div class="position-relative d-inline-block mb-5">
        {% if profile_user.profile_picture %}
            <img src="{{ profile_user.profile_picture.url }}"
                 class="profile-avatar rounded-circle"
                 width="140" height="140"
                 alt="{{ profile_user.username }}'s profile picture">
        {% else %}
            <img src="{% static 'network/images/default-avatar.png' %}"
                 class="profile-avatar rounded-circle"
                 width="140" height="140"
                 alt="Default avatar">
        {% endif %}

        {% if user == profile_user %}
            <label for="id_profile_picture_quick"
                   class="position-absolute profile-upload-label">
                <div class="profile-upload-icon rounded-circle d-flex align-items-center justify-content-center shadow-lg">
                    +
                </div>
            </label>

            <form method="post" enctype="multipart/form-data"
                  action="{% url 'quick_upload_picture' %}"
                  style="display:none;">
                {% csrf_token %}
                <input type="file" name="profile_picture"
                       id="id_profile_picture_quick"
                       accept="image/*"
                       onchange="this.form.submit();">
            </form>
        {% endif %}
    </div>

    <h3 class="mb-2" style="color: var(--muted-dark); font-weight: 900;">{{ profile_user.username }}</h3>

    {% if profile_user.bio %}
        <p class="text-muted mb-3" style="max-width: 500px; margin: 0 auto; color: rgba(8,48,71,0.78) !important;">{{ profile_user.bio }}</p>
    {% endif %}

    <p class="text-muted mb-4">
        {% if profile_user.gender == 'M' %}♂ Male
        {% elif profile_user.gender == 'F' %}♀ Female
        {% elif profile_user.gender == 'O' %}⚧ Other
        {% else %}• Prefer not to say
        {% endif %}
    </p>

    <p class="mb-4">
        <strong data-followers-count>
            <a href="{% url 'followers_list' profile_user.username %}" 
               class="text-decoration-none"
               style="color: var(--brand-blue) !important; font-weight: 800;">
                {{ profile_user.followers.count }} followers
            </a>
        </strong> • 
        <strong>
            <a href="{% url 'following_list' profile_user.username %}" 
               class="text-decoration-none"
               style="color: var(--brand-blue) !important; font-weight: 800;">
                {{ profile_user.following.count }} following
            </a>
        </strong>
    </p>

    <div class="d-flex justify-content-center profile-actions mt-3">

        {% if user.is_authenticated and user != profile_user %}
            <!-- Follow Button with block check -->
            {% if can_follow %}
                <button class="btn profile-action-btn mb-2 {% if is_following %}btn-following{% else %}btn-not-following{% endif %}"
                        id="follow-btn"
                        data-username="{{ profile_user.username }}">
                    {% if is_following %}Unfollow{% else %}Follow{% endif %}
                </button>
            {% else %}
                <button class="btn profile-action-btn mb-2" disabled
                        style="background: linear-gradient(90deg, rgba(108, 117, 125, 0.1), rgba(108, 117, 125, 0.08)) !important;
                               color: #6c757d !important;
                               border: 2px solid #6c757d !important;">
                    {% if is_blocked %}You blocked{% else %}You are blocked{% endif %}
                </button>
            {% endif %}

            <!-- Message Button with block check -->
            {% if can_message %}
                <a href="{% url 'conversation' profile_user.username %}"
                   class="btn profile-action-btn mb-2"
                   style="background: linear-gradient(90deg, rgba(14, 97, 150, 0.1), rgba(6, 182, 212, 0.08)) !important;
                          color: var(--brand-blue) !important;
                          border: 2px solid var(--brand-blue) !important;">
                    Message
                </a>
            {% else %}
                <button class="btn profile-action-btn mb-2" disabled
                        style="background: linear-gradient(90deg, rgba(108, 117, 125, 0.1), rgba(108, 117, 125, 0.08)) !important;
                               color: #6c757d !important;
                               border: 2px solid #6c757d !important;">
                    {% if is_blocked %}You blocked{% else %}You are blocked{% endif %}
                </button>
            {% endif %}
            
            <!-- Block/Unblock Button -->
            <button class="btn profile-action-btn mb-2 {% if is_blocked %}btn-blocked{% else %}btn-not-blocked{% endif %}"
                    onclick="handleBlock('{{ profile_user.username }}', this)"
                    style="{% if is_blocked %}
                               background: linear-gradient(90deg, #dc3545, #c82333) !important;
                               color: white !important;
                               border: none !important;
                           {% else %}
                               background: transparent !important;
                               color: #dc3545 !important;
                               border: 2px solid #dc3545 !important;
                           {% endif %}">
                {% if is_blocked %}Unblock{% else %}Block{% endif %}
            </button>

            <!-- Report Button - Harmonized -->
            <button class="btn profile-action-btn mb-2"
                    onclick="openReportModal('{{ profile_user.username }}', {{ profile_user.id }})"
                    style="background: linear-gradient(90deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.08)) !important;
                           color: #ffc107 !important;
                           border: 2px solid #ffc107 !important;">
                Report
            </button>
        {% endif %}

        {% if user == profile_user %}
            <!-- Edit Bio Button - Harmonized -->
            <a href="{% url 'edit_profile' %}" 
               class="btn profile-action-btn mb-2"
               style="background: linear-gradient(90deg, rgba(108, 117, 125, 0.1), rgba(108, 117, 125, 0.08)) !important;
                      color: #6c757d !important;
                      border: 2px solid #6c757d !important;">
                Edit Bio
            </a>

            <!-- Settings Button - Harmonized -->
            <a href="{% url 'privacy_settings' %}" 
               class="btn profile-action-btn mb-2"
               style="background: linear-gradient(90deg, rgba(23, 162, 184, 0.1), rgba(23, 162, 184, 0.08)) !important;
                      color: #17a2b8 !important;
                      border: 2px solid #17a2b8 !important;">
                <i class="fas fa-cog"></i> Settings
            </a>
        {% endif %}
    </div>
</div>

<h4 class="mb-4" style="color: var(--muted-dark); font-weight: 800;">Posts</h4>
{% include "network/partials/post_list.html" %}

<!-- Report Modal - Styled to match theme -->
<div class="modal fade" id="reportModal" tabindex="-1" role="dialog" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96)) !important;
                                         border: 1px solid rgba(8,48,71,0.04) !important;
                                         border-radius: 16px !important;
                                         box-shadow: 0 20px 60px rgba(2,6,23,0.08) !important;">
            <div class="modal-header" style="border-bottom: 1px solid rgba(8,48,71,0.08) !important;">
                <h5 class="modal-title" id="reportModalLabel" style="color: var(--muted-dark); font-weight: 800;">Report User</h5>
                <button type="button" class="close" onclick="closeReportModal()" aria-label="Close">
                    <span aria-hidden="true" style="color: var(--muted-dark);">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <textarea id="reportReason" 
                          class="form-control" 
                          rows="4" 
                          placeholder="Describe the issue (minimum 10 characters)..."
                          style="border: 1px solid rgba(8,48,71,0.12) !important;
                                 border-radius: 10px !important;
                                 font-family: Inter, system-ui, -apple-system, sans-serif !important;
                                 padding: 12px;"></textarea>
            </div>
            <div class="modal-footer" style="border-top: 1px solid rgba(8,48,71,0.08) !important;">
                <button type="button" 
                        class="btn"
                        onclick="closeReportModal()"
                        style="background: linear-gradient(90deg, rgba(108, 117, 125, 0.1), rgba(108, 117, 125, 0.08)) !important;
                               color: #6c757d !important;
                               border: 2px solid #6c757d !important;
                               border-radius: 10px !important;
                               font-weight: 700 !important;
                               padding: 10px 20px !important;">
                    Cancel
                </button>
                <button type="button" 
                        class="btn"
                        onclick="handleReport()"
                        style="background: linear-gradient(90deg, #ffc107, #e0a800) !important;
                               color: #212529 !important;
                               border: none !important;
                               border-radius: 10px !important;
                               font-weight: 800 !important;
                               padding: 10px 20px !important;">
                    Submit Report
                </button>
            </div>
        </div>
    </div>
</div>

<script>
/* BLOCK USER - WORKING */
function handleBlock(username, button) {
    const csrf = document.querySelector('[name="csrfmiddlewaretoken"]').value;
    if (!confirm(button.textContent.trim() === 'Block' ? 'Block this user?' : 'Unblock this user?')) return;

    fetch(`/toggle-block/${username}/`, {
        method: 'POST',
        headers: {'X-CSRFToken': csrf}
    })
    .then(r => r.json())
    .then(() => location.reload());
}

/* REPORT USER FUNCTIONS - FIXED WITH INLINE ONCLICK */
let reportUsername = '';
let reportUserId = 0;

function openReportModal(username, userId) {
    reportUsername = username;
    reportUserId = userId;
    document.getElementById('reportReason').value = '';
    
    // Bootstrap 4 manual modal show
    $('#reportModal').modal('show');
}

function closeReportModal() {
    $('#reportModal').modal('hide');
    document.getElementById('reportReason').value = '';
}

function handleReport() {
    const reason = document.getElementById('reportReason').value.trim();
    if (reason.length < 10) {
        alert('Please provide a detailed reason (minimum 10 characters).');
        return false;
    }
    
    const email = 'mahmudurrahman23@yahoo.com';
    const subject = `Report User: ${reportUsername}`;
    const body = `User: ${reportUsername} (ID: ${reportUserId})\n\nReason:\n${reason}\n\nReported by: {{ user.username }}\nReported at: ${new Date().toLocaleString('en-US', {timeZone: 'Asia/Dhaka'})}`;
    
    // Close modal first
    closeReportModal();
    
    // Open email client
    window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

// Close modal when clicking backdrop
document.addEventListener('click', function(e) {
    if (e.target.id === 'reportModal') {
        closeReportModal();
    }
});

document.addEventListener('keyup', function(e) {
    if (e.key === 'Escape' && document.getElementById('reportModal').style.display === 'block') {
        closeReportModal();
    }
});
</script>

{% endblock %}

{% block script %}{% endblock %} 
