<!-- network/templates/network/partials/comment_item.html -->
{% load static %}
{% load parse_media %}  

<div class="comment-item mb-3 p-3 bg-light rounded" data-comment-id="{{ comment.id }}" style="{% if depth > 0 %}margin-left: {{ depth }}rem;{% endif %}">
    <div class="d-flex align-items-start">
        {% if comment.user.profile_picture %}
            <img src="{{ comment.user.profile_picture.url }}" class="rounded-circle me-3" width="40" height="40" style="object-fit: cover;">
        {% else %}
            <img src="{% static 'network/images/default-avatar.png' %}"
                 class="rounded-circle me-3" width="40" height="40"
                 style="object-fit: cover; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        {% endif %}
       
        <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <strong>
                        <a href="{% url 'profile' comment.user.username %}" class="text-dark text-decoration-none">
                            {{ comment.user.username }}
                        </a>
                    </strong>
                    <small class="text-muted ms-2">{{ comment.timestamp|timesince }} ago</small>
                   
                    {% if comment.parent and comment.parent.user %}
                    <div class="mt-1">
                        <small class="text-muted">
                            â†³ Replying to
                            <a href="{% url 'profile' comment.parent.user.username %}" class="text-primary text-decoration-none fw-semibold">
                                @{{ comment.parent.user.username }}
                            </a>
                        </small>
                    </div>
                    {% endif %}
                </div>
               
                <div class="comment-actions">
                    {% if request.user == comment.user %}
                        <button class="btn btn-sm btn-outline-danger delete-comment" data-comment-id="{{ comment.id }}" type="button">
                            Delete
                        </button>
                        <button class="btn btn-sm btn-outline-primary edit-comment ms-2" data-comment-id="{{ comment.id }}" type="button">
                            Edit
                        </button>
                    {% endif %}
                </div>
            </div>
           
            <!-- Parsed comment text -->
            <div class="comment-text mb-2">
                {{ comment.content|parse_media|safe }}
            </div>
           
            <!-- Edit form (hidden by default) -->
            <div class="edit-form mt-3 d-none" data-comment-id="{{ comment.id }}">
                <textarea class="form-control mb-2 edit-textarea" rows="2">{{ comment.content }}</textarea>
                <button type="button" class="btn btn-primary btn-sm save-edit">Save</button>
                <button type="button" class="btn btn-outline-secondary btn-sm cancel-edit">Cancel</button>
            </div>
           
            <!-- Reply button - MAX 3 LEVELS -->
            {% if user.is_authenticated and depth < 2 %}
                <button class="btn btn-sm btn-link text-primary reply-btn p-0" data-comment-id="{{ comment.id }}" type="button">
                    â†© Reply
                </button>
            {% elif user.is_authenticated and depth >= 2 %}
                <small class="text-muted">
                    â“˜ Maximum reply depth reached
                </small>
            {% endif %}
           
            <!-- Reply form -->
            {% if user.is_authenticated and depth < 2 %}
                <div class="reply-form mt-3 d-none" data-parent-id="{{ comment.id }}">
                    <form method="post" action="{% url 'add_comment' post.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="parent_id" value="{{ comment.id }}">
                       
                        <div class="replying-to-indicator mb-2">
                            â†³ Replying to <a href="{% url 'profile' comment.user.username %}" class="text-primary">@{{ comment.user.username }}</a>
                        </div>
                       
                        <textarea name="content" class="form-control reply-textarea mb-2" rows="2"
                                  placeholder="Write your reply..." required data-reply-to="{{ comment.id }}"></textarea>
                       
                        <!-- GIF/Sticker Picker for Replies -->
                        <div class="gif-picker-comment-section mb-2" data-reply-to="{{ comment.id }}" style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">ðŸŽ¨ Add Media</small>
                                <button type="button" class="btn btn-sm btn-outline-primary browse-media-comment" data-reply-to="{{ comment.id }}">
                                    Browse
                                </button>
                            </div>
                           
                            <div class="btn-group w-100 mb-2">
                                <button type="button" class="btn btn-sm btn-outline-primary active comment-media-type"
                                        data-reply-to="{{ comment.id }}" data-media-type="gifs">GIFs</button>
                                <button type="button" class="btn btn-sm btn-outline-primary comment-media-type"
                                        data-reply-to="{{ comment.id }}" data-media-type="stickers">Stickers</button>
                            </div>
                           
                            <div class="input-group input-group-sm mb-2">
                                <input type="text" class="form-control comment-media-search"
                                       placeholder="Search GIFs..." data-reply-to="{{ comment.id }}">
                                <button type="button" class="btn btn-primary comment-media-search-btn" data-reply-to="{{ comment.id }}">
                                    Search
                                </button>
                            </div>
                           
                            <div class="comment-media-results" data-reply-to="{{ comment.id }}" style="display: none;"></div>
                        </div>
                       
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-sm">
                                Send Reply
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm cancel-reply">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            {% endif %}
           
            <!-- Nested replies -->
            {% if depth < 2 %}
                {% for reply in comment.replies.all %}
                    {% with comment=reply depth=depth|add:1 %}
                        {% include "network/partials/comment_item.html" %}
                    {% endwith %}
                {% endfor %}
            {% endif %}
        </div>
    </div>
</div>

<!-- ADD THIS SCRIPT HERE - RIGHT AFTER THE FINAL </div> -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.comment-text img').forEach(img => {
        img.onerror = function() {
            this.src = 'https://via.placeholder.com/200x150/cccccc/666666?text=Media+Failed';
            this.alt = 'Failed to load media';
            this.style.opacity = '0.7';
        };
    });
});
</script>
