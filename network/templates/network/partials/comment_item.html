<!--
================================================================================
ARGON SOCIAL NETWORK - COMMENT ITEM (RECURSIVE)
================================================================================

@file        comment_item.html
@purpose     Recursive comment display with nested threading
@author      Argon Admin
@date        February 2026
@extends     None (included template)
@requires    parse_media, comment_filters, Bootstrap 4, Font Awesome
@context     comment, post, request.user

FEATURES:
‚Ä¢ Recursive comment threading (nested replies)
‚Ä¢ Edit comment inline
‚Ä¢ Delete with confirmation
‚Ä¢ Reply form toggle
‚Ä¢ Vote system (thumbs up/down)
‚Ä¢ Media parsing (GIFs, @mentions)
‚Ä¢ Privacy-aware display

RECURSIVE STRUCTURE:
Comment (depth=0)
‚îú‚îÄ‚îÄ Reply 1 (depth=1)
‚îÇ   ‚îú‚îÄ‚îÄ Reply 1.1 (depth=2)
‚îÇ   ‚îî‚îÄ‚îÄ Reply 1.2 (depth=2)
‚îî‚îÄ‚îÄ Reply 2 (depth=1)

FILE LOCATION: templates/network/partials/comment_item.html
INCLUDES: Itself (recursive) network/partials/comment_item.html

================================================================================
-->

{# network/partials/comment_item.html #}
{% load static %}
{% load parse_media %}
{% load comment_filters %}

<style> 
/* COMMENT ACTION MENU (per comment) */

.comment-actions {
  position: relative;
}

.comment-actions .action-menu-toggle {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.2rem;
  line-height: 1;
  padding: 0.25rem 0.5rem;
  color: #6c757d;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  border-radius: 50%;
}

.comment-actions .action-menu-toggle:hover {
  background-color: rgba(0,0,0,0.05);
}

.comment-actions .action-menu-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  z-index: 1000;
  display: none;
  min-width: 100px;
  background: #fff;
  border: 1px solid rgba(0,0,0,.15);
  border-radius: 0.25rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  margin-top: 5px;
}

.comment-actions .action-menu-dropdown.show {
  display: block;
}

.comment-actions .action-menu-item {
  display: block;
  width: 100%;
  padding: 0.5rem 0.75rem;
  border: none;
  background: none;
  text-align: left;
  cursor: pointer;
  color: #212529;
  font-size: 13px;
  white-space: nowrap;
}

.comment-actions .action-menu-item:hover {
  background-color: #f8f9fa;
}

/* USERNAME TRUNCATION (same logic as post_list) */

.comment-submeta .text-primary,
.comment-submeta .font-weight-bold {
  display: inline-block !important;
  max-width: min(120px, 30vw) !important;
  min-width: 50px !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
  vertical-align: bottom !important;
}

@media (max-width: 380px) {
  .comment-submeta .text-primary,
  .comment-submeta .font-weight-bold {
    max-width: min(80px, 22vw) !important;
  }
  .comment-submeta {
    font-size: 0.85rem;
  }
}

.comment-submeta {
  min-width: 0;
  flex-shrink: 1;
}

/* MOBILE POSITIONING (no bottom-sheet here) */

@media (max-width: 576px) {
  .comment-item .comment-header {
    position: relative !important;
    padding-right: 40px !important;
  }

  .comment-item .comment-actions {
    position: absolute !important;
    top: 0 !important;
    right: 0 !important;
    margin: 0 !important;
    flex-shrink: 0;
    z-index: 10;
  }

  .comment-item[data-depth="1"] .comment-actions {
    top: -4px !important;
    right: -4px !important;
  }

  .comment-item[data-depth="2"] .comment-actions,
  .comment-item[data-depth="3"] .comment-actions {
    top: -2px !important;
    right: -2px !important;
  }
}

/* COMMENT BODY VISUALS */

.comment-item {
  background: #f8fafc;
}

.comment-item[data-depth="0"] {
  background: #f8fafc;
}

.comment-item[data-depth]:not([data-depth="0"]) {
  background: #ffffff;
  border: 1px solid rgba(148,163,184,0.35);
}

/* INLINE GIF/STICKER INSIDE COMMENTS */

.comment-text img[alt="GIF"],
.comment-text img[alt="Sticker"]{
  display:block;
  height:auto;
  max-width:100% !important;
}
.comment-text img[alt="GIF"]{ width: min(280px, 100%) !important; }
.comment-text img[alt="Sticker"]{ width: min(140px, 100%) !important; }
@media (max-width:576px){
  .comment-text img[alt="GIF"]{ width: 100% !important; }
  .comment-text img[alt="Sticker"]{ width: min(200px, 100%) !important; }
}
</style>

<div class="comment-item mb-3 p-3 rounded"
     data-comment-id="{{ comment.id }}"
     data-depth="{{ depth }}"
     style="--depth: {{ depth }};">
  <div class="d-flex align-items-start" style="min-width:0;">
    {% if comment.user.profile_picture %}
      <img src="{{ comment.user.profile_picture.url }}"
           class="rounded-circle mr-3"
           width="40" height="40"
           style="object-fit: cover;"
           alt="{{ comment.user.username }}"
           onerror="this.src='{% static 'network/images/default-avatar.png' %}'">
    {% else %}
      <img src="{% static 'network/images/default-avatar.png' %}"
           class="rounded-circle mr-3"
           width="40" height="40"
           alt="{{ comment.user.username }}"
           style="object-fit: cover; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    {% endif %}

    <div class="flex-grow-1" style="min-width:0;">
      <div class="comment-header d-flex flex-wrap justify-content-between align-items-start mb-1" style="gap:10px;">
        <div class="comment-meta" style="min-width:0;">
          <strong>
            <a href="{% url 'profile' comment.user.username %}"
               class="text-dark text-decoration-none">
              {{ comment.user.username }}
            </a>
          </strong>

          <div class="comment-submeta mt-1">
            <small class="text-muted d-flex flex-wrap align-items-center" style="gap:6px;">
              <span>{{ comment.timestamp|timesince }} ago</span>

              {% if comment.parent %}
                <span class="d-inline-flex flex-wrap align-items-center" style="gap:4px;">
                  <i class="fas fa-reply mr-1"></i>
                  <span>Replying to</span>
                  {% if comment.parent.user %}
                    <a href="{% url 'profile' comment.parent.user.username %}"
                       class="text-primary text-decoration-none font-weight-bold"
                       style="max-width:100%;overflow:hidden;text-overflow:ellipsis;">
                      @{{ comment.parent.user.username }}
                    </a>
                  {% else %}
                    <span class="text-muted">(deleted user)</span>
                  {% endif %}
                </span>
              {% endif %}
            </small>
          </div>
        </div>

        {% if request.user == comment.user %}
          <div class="comment-actions" style="flex-shrink:0;">
            <div class="action-menu">
              <button type="button"
                      class="action-menu-toggle js-action-menu-toggle"
                      aria-label="Comment actions"
                      aria-expanded="false">
                <i class="fas fa-ellipsis-v"></i>
              </button>

              <div class="action-menu-dropdown js-action-menu" role="menu" aria-hidden="true">
                <button type="button"
                        class="action-menu-item edit-comment"
                        data-comment-id="{{ comment.id }}">
                  <i class="fas fa-edit mr-2"></i>Edit
                </button>
                <button type="button"
                        class="action-menu-item delete-comment"
                        data-comment-id="{{ comment.id }}">
                  <i class="fas fa-trash mr-2"></i>Delete
                </button>
              </div>
            </div>
          </div>
        {% endif %}
      </div>

      <div class="comment-text mb-2">
        {{ comment.content|parse_media|safe }}
      </div>

      {# FILE OR URL-BASED MEDIA FALLBACK #}
      {% if comment.media %}
        <div class="mb-2">
          {% if comment.media_type == 'image' %}
            <img src="{{ comment.media.url }}"
                 alt="Comment image"
                 class="img-fluid rounded"
                 style="max-height:400px;object-fit:contain;">
          {% elif comment.media_type == 'video' %}
            <video controls class="w-100 rounded" style="max-height:400px;">
              <source src="{{ comment.media.url }}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          {% endif %}
        </div>
      {% elif comment.media_url %}
        <div class="mb-2">
          {% if comment.media_type == 'gif' or comment.media_type == 'sticker' %}
            <img src="{{ comment.media_url }}"
                 alt="{% if comment.media_type == 'gif' %}GIF{% else %}Sticker{% endif %}"
                 class="img-fluid rounded"
                 style="max-height:280px;object-fit:contain;">
          {% elif comment.media_type == 'image' %}
            <img src="{{ comment.media_url }}"
                 alt="Comment image"
                 class="img-fluid rounded"
                 style="max-height:400px;object-fit:contain;">
          {% elif comment.media_type == 'video' %}
            <video controls class="w-100 rounded" style="max-height:400px;">
              <source src="{{ comment.media_url }}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          {% endif %}
        </div>
      {% endif %}

      <div class="edit-form mt-3 d-none" data-comment-id="{{ comment.id }}">
        <textarea class="form-control mb-2 edit-textarea" rows="2">{{ comment.content }}</textarea>
        <div class="d-flex" style="gap:8px;">
          <button type="button"
                  class="btn btn-primary btn-sm save-edit">
            Save
          </button>
          <button type="button"
                  class="btn btn-outline-secondary btn-sm cancel-edit">
            Cancel
          </button>
        </div>
      </div>

      {% if depth == 0 %}
        {% with visible_replies=comment.replies.all|filter_by_privacy:request.user %}
          <div class="d-flex flex-wrap align-items-center" style="gap:12px;">
            {% if user.is_authenticated %}
              <button class="btn btn-sm btn-link text-primary reply-btn p-0"
                      data-comment-id="{{ comment.id }}"
                      type="button">
                <i class="fas fa-reply mr-1"></i> Reply
              </button>
            {% endif %}

            {% if visible_replies|length > 0 %}
              <button type="button"
                      class="btn btn-sm btn-link text-secondary p-0 js-toggle-replies"
                      data-comment-id="{{ comment.id }}"
                      data-count="{{ visible_replies|length }}"
                      aria-expanded="false">
                Show replies ({{ visible_replies|length }})
              </button>
            {% endif %}
          </div>

          {% if user.is_authenticated %}
            <div class="reply-form mt-3 d-none" data-parent-id="{{ comment.id }}">
              <form method="post"
                    action="{% url 'add_comment' post.id %}"
                    class="js-media-form"
                    data-composer-id="reply-{{ comment.id }}"
                    enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="parent_id" value="{{ comment.id }}">

                <div class="replying-to-indicator mb-2">
                  <i class="fas fa-reply mr-1"></i>
                  Replying to
                  <a href="{% url 'profile' comment.user.username %}"
                     class="text-primary">@{{ comment.user.username }}</a>
                </div>

                <div class="comment-composer">
                  <div class="media-previews-container">
                    <div class="media-previews-list" data-preview="reply-{{ comment.id }}"></div>
                    <div class="media-stats" data-stats="reply-{{ comment.id }}"></div>
                  </div>

                  <textarea name="content"
                            class="form-control auto-expand-textarea js-mention-input"
                            data-mention-scope="global"
                            rows="1"
                            placeholder="Write a reply..."
                            required></textarea>

                  <div class="composer-media-row" data-row="reply-{{ comment.id }}">
                    <button type="button"
                            class="composer-media-btn"
                            data-type="gifs"
                            title="GIFs">üéûÔ∏è</button>
                    <button type="button"
                            class="composer-media-btn"
                            data-type="stickers"
                            title="Stickers">üè∑Ô∏è</button>
                    <button type="button"
                            class="composer-media-btn composer-file-btn"
                            data-file-kind="image"
                            title="Attach image">üì∑</button>
                    <button type="button"
                            class="composer-media-btn composer-file-btn"
                            data-file-kind="video"
                            title="Attach video">üé•</button>

                    <div class="composer-search-group">
                      <input type="text"
                             class="composer-search-input"
                             placeholder="Search GIFs or stickers...">
                      <button type="button"
                              class="composer-search-btn"
                              title="Search">
                        <i class="fas fa-search"></i>
                      </button>
                    </div>

                    <div class="composer-results" data-results="reply-{{ comment.id }}"></div>
                  </div>

                  <input type="file"
                         name="media"
                         class="js-composer-file-input d-none"
                         accept="image/*,video/*">
                  <input type="hidden"
                         class="media-data-input"
                         value="[]">
                </div>

                <button type="submit"
                        class="btn btn-primary btn-sm mt-2">
                  Reply
                </button>
              </form>
            </div>
          {% endif %}

          {% if visible_replies|length > 0 %}
            <div class="js-replies replies mt-3 d-none"
       data-parent-id="{{ comment.id }}">
    {% for reply in visible_replies %}
      {% include "network/partials/comment_item.html" with comment=reply post=post depth=1 %}
    {% endfor %}
  </div>
          {% endif %}
        {% endwith %}
      {% endif %}
    </div>
  </div>
</div>


<!--
================================================================================
END OF comment_item.html - Author: Argon Admin
================================================================================
-->
