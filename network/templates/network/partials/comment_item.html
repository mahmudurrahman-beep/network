{# comment_item.html - FIXED #}
{% load static %}
{% load parse_media %}
{% load comment_filters %}

<div class="comment-item mb-3 p-3 {% if depth == 0 %}bg-light{% else %}bg-white border{% endif %} rounded"
     data-comment-id="{{ comment.id }}"
     data-depth="{{ depth }}"
     style="--depth: {{ depth }};">
  <div class="d-flex align-items-start" style="min-width:0;">
    {% if comment.user.profile_picture %}
      <img src="{{ comment.user.profile_picture.url }}" class="rounded-circle mr-3"
           width="40" height="40" style="object-fit: cover;">
    {% else %}
      <img src="{% static 'network/images/default-avatar.png' %}"
           class="rounded-circle mr-3" width="40" height="40"
           style="object-fit: cover; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    {% endif %}

    <div class="flex-grow-1" style="min-width:0;">
      <div class="comment-header d-flex flex-wrap justify-content-between align-items-start mb-2" style="gap:10px;">
        <div class="comment-meta" style="min-width:0;">
          <strong>
            <a href="{% url 'profile' comment.user.username %}" class="text-dark text-decoration-none">
              {{ comment.user.username }}
            </a>
          </strong>

          <div class="comment-submeta mt-1">
            <small class="text-muted d-flex flex-wrap align-items-center" style="gap:8px;">
              <span>{{ comment.timestamp|timesince }} ago</span>

              {% if comment.parent %}
                <span class="d-inline-flex flex-wrap align-items-center" style="gap:4px;">
                  <i class="fas fa-reply mr-1"></i>
                  <span>Replying to</span>
                  {% if comment.parent.user %}
                    <a href="{% url 'profile' comment.parent.user.username %}"
                       class="text-primary text-decoration-none font-weight-bold"
                       style="display:inline-block; max-width:100%; overflow:hidden; text-overflow:ellipsis;">
                      @{{ comment.parent.user.username }}
                    </a>
                  {% else %}
                    <span class="text-muted">(deleted user)</span>
                  {% endif %}
                </span>
              {% endif %}
            </small>
          </div>
        </div>

        {% if request.user == comment.user %}
          <div class="comment-actions" style="flex-shrink:0;">
            <div class="action-menu">
              <button type="button"
                      class="action-menu-toggle js-action-menu-toggle"
                      aria-label="Comment actions"
                      aria-expanded="false">â‹®</button>

              <div class="action-menu-dropdown js-action-menu" role="menu" aria-hidden="true">
                <button type="button"
                        class="action-menu-item edit-comment"
                        data-comment-id="{{ comment.id }}">
                  Edit
                </button>
                <button type="button"
                        class="action-menu-item delete-comment"
                        data-comment-id="{{ comment.id }}">
                  Delete
                </button>
              </div>
            </div>
          </div>
        {% endif %}
      </div>

      <div class="comment-text mb-2">
        {{ comment.content|parse_media|safe }}
      </div>

      <div class="edit-form mt-3 d-none" data-comment-id="{{ comment.id }}">
        <textarea class="form-control mb-2 edit-textarea" rows="2">{{ comment.content }}</textarea>
        <button type="button" class="btn btn-primary btn-sm save-edit">Save</button>
        <button type="button" class="btn btn-outline-secondary btn-sm cancel-edit">Cancel</button>
      </div>

      {% if depth == 0 %}
        {% with visible_replies=comment.replies.all|filter_by_privacy:request.user %}
          <div class="d-flex flex-wrap align-items-center" style="gap:12px;">
            {% if user.is_authenticated %}
              <button class="btn btn-sm btn-link text-primary reply-btn p-0" data-comment-id="{{ comment.id }}" type="button">
                <i class="fas fa-reply mr-1"></i> Reply
              </button>
            {% endif %}

            {% if visible_replies|length > 0 %}
              <button type="button"
                      class="btn btn-sm btn-link text-secondary p-0 js-toggle-replies"
                      data-comment-id="{{ comment.id }}"
                      data-count="{{ visible_replies|length }}"
                      aria-expanded="false">
                Show replies ({{ visible_replies|length }})
              </button>
            {% endif %}
          </div>

          {% if user.is_authenticated %}
            <div class="reply-form mt-3 d-none" data-parent-id="{{ comment.id }}">
              <form method="post" action="{% url 'add_comment' post.id %}" class="js-media-form"
                    data-composer-id="reply-{{ comment.id }}">
                {% csrf_token %}
                <input type="hidden" name="parent_id" value="{{ comment.id }}">

                <div class="replying-to-indicator mb-2">
                  <i class="fas fa-reply mr-1"></i>
                  Replying to <a href="{% url 'profile' comment.user.username %}" class="text-primary">@{{ comment.user.username }}</a>
                </div>

                <div class="comment-composer">
                  <div class="composer-preview" data-preview="reply-{{ comment.id }}"></div>

                  <textarea name="content" class="form-control" rows="2"
                            placeholder="Write your reply..." required></textarea>

                  <div class="composer-media-row" data-row="reply-{{ comment.id }}">
                    <button type="button" class="composer-media-btn active" data-type="gifs" title="GIFs">ğŸï¸</button>
                    <button type="button" class="composer-media-btn" data-type="stickers" title="Stickers">ğŸ·ï¸</button>

                    <input type="text" class="composer-search-input" placeholder="Search GIFs or Stickers...">
                    <button type="button" class="composer-search-btn"><i class="fas fa-search"></i></button>

                    <div class="composer-results" data-results="reply-{{ comment.id }}"></div>
                  </div>

                  <input type="hidden" class="media-data-input" value="[]">
                </div>

                <div class="d-flex mt-2" style="gap:8px;">
                  <button type="submit" class="btn btn-primary btn-sm">Send Reply</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm cancel-reply">Cancel</button>
                </div>
              </form>
            </div>
          {% endif %}

          {% if visible_replies|length > 0 %}
            <div class="js-replies d-none mt-3" data-parent-id="{{ comment.id }}">
              {% for reply in visible_replies %}
                {% with comment=reply depth=1 %}
                  {% include "network/partials/comment_item.html" %}
                {% endwith %}
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
      {% endif %}
    </div>
  </div>
</div>
